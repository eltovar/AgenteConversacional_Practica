# PLAN DE IMPLEMENTACIÃ“N - FASE COMPLEMENTARIA
## CorrecciÃ³n de Inconsistencias + Campos Requeridos: Correo y Tiempo

**Fecha:** 23 de enero de 2026  
**VersiÃ³n:** 2.1 (Complemento a v2.0)  
**PropÃ³sito:** Resolver inconsistencias detectadas y agregar `correo` y `tiempo` como campos obligatorios

---

## ÃNDICE

1. [Resumen de Inconsistencias](#1-resumen-de-inconsistencias)
2. [Lista de Tareas Adicionales](#2-lista-de-tareas-adicionales)
3. [FASE 5: CorrecciÃ³n de Campos Requeridos](#3-fase-5-correcciÃ³n-de-campos-requeridos)
4. [FASE 6: ConfiguraciÃ³n HubSpot (Nuevas Propiedades)](#4-fase-6-configuraciÃ³n-hubspot-nuevas-propiedades)
5. [Variables de Entorno](#5-variables-de-entorno)
6. [Checklist de VerificaciÃ³n](#6-checklist-de-verificaciÃ³n)

---

## 1. RESUMEN DE INCONSISTENCIAS

| # | Inconsistencia | Causa RaÃ­z | SoluciÃ³n |
|---|----------------|------------|----------|
| 1 | `PROPERTY_DATA_COMPLETE_PROMPT` usa `{correo}` y `{tiempo}` pero llegan vacÃ­os | No estÃ¡n en `REQUIRED_PROPERTY_FIELDS` | Agregar a campos requeridos |
| 2 | Prompts para `"correo"` y `"tiempo"` en `PROPERTY_QUALIFICATION_PROMPTS` son cÃ³digo muerto | Solo se itera sobre `REQUIRED_PROPERTY_FIELDS` | Agregar campos a la lista requerida |
| 3 | `PROPERTY_EXTRACTION_PROMPT` no extrae `correo` ni `tiempo` | El LLM no sabe que debe extraerlos | Actualizar prompt de extracciÃ³n |

---

## 2. LISTA DE TAREAS ADICIONALES

### 2.1 Tareas de CÃ³digo

| # | Tarea | Archivo | Prioridad |
|---|-------|---------|-----------|
| 15 | Agregar `correo` y `tiempo` a `REQUIRED_PROPERTY_FIELDS` | `reception_agent.py` | ALTA |
| 16 | Actualizar `PROPERTY_EXTRACTION_PROMPT` para extraer `correo` y `tiempo` | `crm_prompts.py` | ALTA |
| 17 | Verificar/corregir `PROPERTY_QUALIFICATION_PROMPTS` | `crm_prompts.py` | ALTA |
| 18 | Actualizar `PROPERTY_DATA_COMPLETE_PROMPT` | `crm_prompts.py` | ALTA |
| 19 | Agregar `chatbot_email` y `chatbot_urgency` a `contact_properties` | `crm_agent.py` | ALTA |
| 20 | Agregar `chatbot_urgency` a `deal_properties` | `crm_agent.py` | MEDIA |

### 2.2 Tareas de ConfiguraciÃ³n HubSpot

| # | Tarea | UbicaciÃ³n | Prioridad |
|---|-------|-----------|-----------|
| 21 | Crear propiedad `chatbot_email` en Contactos | HubSpot Settings | ALTA |
| 22 | Crear propiedad `chatbot_urgency` en Contactos | HubSpot Settings | ALTA |
| 23 | Crear propiedad `chatbot_urgency` en Deals | HubSpot Settings | ALTA |
| 24 | Actualizar vista "Leads_Sofia_Nuevos" con nuevas columnas | HubSpot CRM | MEDIA |
| 25 | Actualizar tarjetas Kanban con `chatbot_urgency` | HubSpot CRM | MEDIA |

---

## 3. FASE 5: CORRECCIÃ“N DE CAMPOS REQUERIDOS

### 3.1 Tarea 15: Actualizar `REQUIRED_PROPERTY_FIELDS`

**Archivo:** `reception_agent.py`  
**LÃ­nea aproximada:** 16-17

```python
# reception_agent.py - MODIFICAR las constantes al inicio del archivo

# ANTES:
REQUIRED_PROPERTY_FIELDS = ['ubicacion', 'presupuesto']
OPTIONAL_PROPERTY_FIELDS = ['caracteristicas', 'tipo_propiedad', 'tipo_operacion']

# DESPUÃ‰S:
REQUIRED_PROPERTY_FIELDS = ['ubicacion', 'presupuesto', 'correo', 'tiempo']
OPTIONAL_PROPERTY_FIELDS = ['caracteristicas', 'tipo_propiedad', 'tipo_operacion', 'comentarios_adicionales']
```

**Nota sobre el orden:** El orden en `REQUIRED_PROPERTY_FIELDS` determina el orden en que se preguntarÃ¡n los campos faltantes. La secuencia recomendada es:
1. `ubicacion` - Zona de interÃ©s (contexto geogrÃ¡fico primero)
2. `presupuesto` - Rango de precio (filtro principal)
3. `correo` - Email para contacto (dato de contacto)
4. `tiempo` - Urgencia/timeline (para priorizaciÃ³n)

---

### 3.2 Tarea 16: Actualizar `PROPERTY_EXTRACTION_PROMPT`

**Archivo:** `crm_prompts.py`  
**LÃ­neas aproximadas:** 11-34

```python
# crm_prompts.py - REEMPLAZAR PROPERTY_EXTRACTION_PROMPT completo

PROPERTY_EXTRACTION_PROMPT = """Analiza el siguiente mensaje del usuario y extrae la informaciÃ³n relevante sobre su interÃ©s inmobiliario.

Extrae las siguientes entidades si estÃ¡n presentes en el mensaje:

DATOS DE LA PROPIEDAD:
- tipo_propiedad: (casa, apartamento, local, oficina, bodega, lote, finca, etc.)
- tipo_operacion: (arriendo, compra, venta)
- ubicacion: (barrio, zona, ciudad, sector)
- presupuesto: (rango de precio mencionado, ej: "2-3 millones", "mÃ¡ximo 300 millones")
- caracteristicas: (nÃºmero de habitaciones, baÃ±os, parqueadero, Ã¡rea en mÂ², piso, estrato, etc.)

DATOS DE CONTACTO Y URGENCIA:
- correo: (direcciÃ³n de email si el usuario la menciona)
- tiempo: (cuÃ¡ndo necesita el inmueble: "inmediato", "este mes", "prÃ³ximos 2 meses", "sin prisa", etc.)
- urgencia: (nivel de urgencia inferido: "alta", "media", "baja" - basado en el contexto)

INFORMACIÃ“N ADICIONAL:
- comentarios_adicionales: (cualquier otra informaciÃ³n relevante mencionada)

REGLAS DE EXTRACCIÃ“N:
1. Solo extrae informaciÃ³n que el usuario mencione EXPLÃCITAMENTE
2. Para "tiempo", busca frases como: "lo necesito para", "me urge", "tengo tiempo", "sin afÃ¡n", "para mudarnos en"
3. Para "correo", busca patrones de email (texto@dominio.com)
4. Si no encuentras una entidad, NO la incluyas en el JSON
5. Normaliza "urgencia" basÃ¡ndote en "tiempo": inmediato/esta semana = "alta", este mes = "media", mÃ¡s de un mes = "baja"

Responde SOLO con un JSON vÃ¡lido. Sin texto adicional, sin explicaciones.

Ejemplo de respuesta:
{{
    "tipo_propiedad": "apartamento",
    "tipo_operacion": "arriendo",
    "ubicacion": "Chapinero",
    "presupuesto": "2-3 millones",
    "caracteristicas": "2 habitaciones, parqueadero",
    "correo": "juan@email.com",
    "tiempo": "prÃ³ximo mes",
    "urgencia": "media"
}}

Mensaje del usuario: {user_message}"""
```

---

### 3.3 Tarea 17: Actualizar `PROPERTY_QUALIFICATION_PROMPTS`

**Archivo:** `crm_prompts.py`  
**SecciÃ³n:** PROMPTS PARA CALIFICACIÃ“N DE LEADS

```python
# crm_prompts.py - REEMPLAZAR PROPERTY_QUALIFICATION_PROMPTS completo

PROPERTY_QUALIFICATION_PROMPTS = {
    "ubicacion": (
        "Â¡Perfecto! Para ayudarte mejor, Â¿en quÃ© zona o barrio te gustarÃ­a "
        "encontrar tu {tipo_propiedad}? ğŸ \n\n"
        "Por ejemplo: Chapinero, UsaquÃ©n, Poblado, Laureles, El Poblado, etc."
    ),
    "presupuesto": (
        "Â¡Excelente! Â¿CuÃ¡l es tu presupuesto aproximado para {tipo_operacion}? ğŸ’°\n\n"
        "Puedes indicarlo como rango, por ejemplo:\n"
        "â€¢ 'Entre 2 y 3 millones' (para arriendo mensual)\n"
        "â€¢ 'MÃ¡ximo 300 millones' (para compra)"
    ),
    "correo": (
        "Â¡Muy bien! Para que nuestro equipo pueda enviarte opciones personalizadas, "
        "Â¿me podrÃ­as compartir tu correo electrÃ³nico? ğŸ“§\n\n"
        "Ejemplo: tu.nombre@email.com"
    ),
    "tiempo": (
        "Â¡Genial! Â¿Para cuÃ¡ndo necesitas el inmueble? â°\n\n"
        "Por ejemplo:\n"
        "â€¢ 'Lo antes posible' o 'Inmediato'\n"
        "â€¢ 'Este mes' o 'En las prÃ³ximas 2 semanas'\n"
        "â€¢ 'En los prÃ³ximos 2-3 meses'\n"
        "â€¢ 'Sin prisa, estoy explorando opciones'"
    ),
    "caracteristicas": (
        "Â¡Muy bien! Â¿Tienes alguna preferencia especÃ­fica? Por ejemplo:\n"
        "â€¢ NÃºmero de habitaciones y baÃ±os\n"
        "â€¢ Parqueadero incluido\n"
        "â€¢ Ãrea mÃ­nima en mÂ²\n"
        "â€¢ Amoblado o sin amoblar\n\n"
        "Si no tienes preferencias especÃ­ficas, puedes escribir 'ninguna' o 'cualquiera'."
    )
}
```

---

### 3.4 Tarea 18: Actualizar `PROPERTY_DATA_COMPLETE_PROMPT`

**Archivo:** `crm_prompts.py`

```python
# crm_prompts.py - REEMPLAZAR PROPERTY_DATA_COMPLETE_PROMPT

PROPERTY_DATA_COMPLETE_PROMPT = (
    "Â¡Perfecto! Ya tengo toda la informaciÃ³n sobre lo que buscas:\n\n"
    "ğŸ“ *Zona:* {ubicacion}\n"
    "ğŸ’° *Presupuesto:* {presupuesto}\n"
    "ğŸ“§ *Correo:* {correo}\n"
    "â° *Tiempo:* {tiempo}\n"
    "{extra_info}"
    "\nÂ¿Es correcto? Si es asÃ­, Â¿me podrÃ­as indicar tu *nombre completo* "
    "para registrarte con nuestro equipo de asesores?"
)
```

---

### 3.5 Tarea 18b: Actualizar `FIELD_LABELS`

**Archivo:** `crm_prompts.py`

```python
# crm_prompts.py - REEMPLAZAR FIELD_LABELS

FIELD_LABELS = {
    "ubicacion": "la zona o barrio de interÃ©s",
    "presupuesto": "tu presupuesto aproximado",
    "correo": "tu correo electrÃ³nico",
    "tiempo": "para cuÃ¡ndo necesitas el inmueble",
    "caracteristicas": "caracterÃ­sticas especÃ­ficas (habitaciones, Ã¡rea, etc.)",
    "tipo_propiedad": "el tipo de propiedad que buscas",
    "tipo_operacion": "si deseas arrendar o comprar"
}
```

---

### 3.6 Tarea 19: Actualizar `contact_properties` en CRMAgent

**Archivo:** `crm_agent.py`  
**UbicaciÃ³n:** Dentro de `process_lead_handoff`, secciÃ³n de `contact_properties`

```python
# crm_agent.py - MODIFICAR contact_properties (aproximadamente lÃ­nea 85-100)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. PROPIEDADES DEL CONTACTO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
contact_properties = {
    # Datos bÃ¡sicos
    "firstname": name_parts["firstname"],
    "lastname": name_parts["lastname"] or "WhatsApp",
    "phone": normalized_phone,
    "whatsapp_id": normalized_phone,  # ID Ãºnico para deduplicaciÃ³n
    
    # Email capturado del chatbot (NUEVO)
    "email": metadata.get("correo", ""),  # Email estÃ¡ndar de HubSpot
    "chatbot_email": metadata.get("correo", ""),  # Copia en campo custom para tracking
    
    # Propiedades del chatbot - Propiedad
    "chatbot_property_type": metadata.get("tipo_propiedad", ""),
    "chatbot_rooms": str(metadata.get("caracteristicas", "")),
    "chatbot_location": metadata.get("ubicacion", ""),
    "chatbot_budget": str(metadata.get("presupuesto", "")),
    
    # Propiedades del chatbot - Urgencia (NUEVO)
    "chatbot_urgency": metadata.get("tiempo", ""),  # Timeline del cliente
    
    # Propiedades del chatbot - Consolidadas
    "chatbot_preference": chatbot_preference,
    "chatbot_conversation": conversation_text,
    "chatbot_score": str(lead_score),
    "chatbot_timestamp": timestamp_ms
}
```

---

### 3.7 Tarea 20: Actualizar `deal_properties` en CRMAgent

**Archivo:** `crm_agent.py`  
**UbicaciÃ³n:** Dentro de `process_lead_handoff`, secciÃ³n de `deal_properties`

```python
# crm_agent.py - MODIFICAR deal_properties (aproximadamente lÃ­nea 130-145)

deal_properties = {
    # Propiedades estÃ¡ndar del Deal
    "dealname": deal_name,
    "amount": self._parse_amount(metadata.get("presupuesto", "0")),
    "description": (
        f"Lead capturado vÃ­a chatbot SofÃ­a.\n"
        f"Canal: {channel_origin}\n"
        f"Interesado en: {metadata.get('ubicacion', 'propiedad')}\n"
        f"Timeline: {metadata.get('tiempo', 'No especificado')}\n"
        f"Score: {lead_score}/100"
    ),
    
    # Propiedades custom del chatbot
    "chatbot_property_type": metadata.get("tipo_propiedad", ""),
    "chatbot_location": metadata.get("ubicacion", ""),
    "chatbot_budget": str(metadata.get("presupuesto", "")),
    "chatbot_score": str(lead_score),
    "chatbot_urgency": metadata.get("tiempo", ""),  # NUEVO: Urgencia tambiÃ©n en Deal
}
```

---

### 3.8 Tarea 19b: Actualizar construcciÃ³n de `chatbot_preference`

**Archivo:** `crm_agent.py`  
**UbicaciÃ³n:** Dentro de `process_lead_handoff`, donde se construye `chatbot_preference`

```python
# crm_agent.py - MODIFICAR construcciÃ³n de chatbot_preference (aproximadamente lÃ­nea 65-80)

# Construir chatbot_preference (consolidado de varias propiedades)
preference_parts = []
if metadata.get("tipo_operacion"):
    preference_parts.append(f"OperaciÃ³n: {metadata['tipo_operacion']}")
if metadata.get("tipo_propiedad"):
    preference_parts.append(f"Tipo: {metadata['tipo_propiedad']}")
if metadata.get("caracteristicas"):
    preference_parts.append(f"CaracterÃ­sticas: {metadata['caracteristicas']}")
if metadata.get("tiempo"):  # NUEVO
    preference_parts.append(f"Timeline: {metadata['tiempo']}")
if metadata.get("urgencia"):
    preference_parts.append(f"Urgencia: {metadata['urgencia']}")
if metadata.get("comentarios_adicionales"):
    preference_parts.append(f"Notas: {metadata['comentarios_adicionales']}")

chatbot_preference = " | ".join(preference_parts) if preference_parts else ""
```

---

### 3.9 Tarea 18c: Actualizar `_handle_awaiting_property_data` para formatear correctamente

**Archivo:** `reception_agent.py`  
**UbicaciÃ³n:** MÃ©todo `_handle_awaiting_property_data`, secciÃ³n donde se formatea `PROPERTY_DATA_COMPLETE_PROMPT`

```python
# reception_agent.py - MODIFICAR en _handle_awaiting_property_data
# Aproximadamente lÃ­neas 260-280

if not missing_fields:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Â¡DATOS COMPLETOS! Pasar a pedir nombre
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    state.status = ConversationStatus.AWAITING_LEAD_NAME
    logger.info("[ReceptionAgent] Datos de propiedad completos. Estado: AWAITING_PROPERTY_DATA â†’ AWAITING_LEAD_NAME")
    
    # Construir informaciÃ³n extra (campos opcionales que estÃ©n presentes)
    extra_info = ""
    if metadata.get('caracteristicas'):
        extra_info += f"ğŸ  *CaracterÃ­sticas:* {metadata['caracteristicas']}\n"
    if metadata.get('tipo_propiedad'):
        extra_info += f"ğŸ“‹ *Tipo:* {metadata['tipo_propiedad']}\n"
    if metadata.get('tipo_operacion'):
        extra_info += f"ğŸ“ *OperaciÃ³n:* {metadata['tipo_operacion']}\n"
    
    response_text = PROPERTY_DATA_COMPLETE_PROMPT.format(
        ubicacion=metadata.get('ubicacion', 'No especificada'),
        presupuesto=metadata.get('presupuesto', 'No especificado'),
        correo=metadata.get('correo', 'No proporcionado'),
        tiempo=metadata.get('tiempo', 'No especificado'),
        extra_info=extra_info
    )
```

---

## 4. FASE 6: CONFIGURACIÃ“N HUBSPOT (NUEVAS PROPIEDADES)

### 4.1 Tarea 21: Crear Propiedad `chatbot_email` en Contactos

**UbicaciÃ³n:** HubSpot â†’ Settings â†’ Data Management â†’ Properties â†’ Contact Properties â†’ Create property

| Campo | Valor |
|-------|-------|
| **Object type** | Contact |
| **Group** | Datos Chatbot |
| **Label** | Email Chatbot |
| **Internal name** | `chatbot_email` |
| **Field type** | Single-line text |
| **Description** | Correo electrÃ³nico capturado por el chatbot SofÃ­a durante la calificaciÃ³n del lead |

**Instrucciones paso a paso:**

1. Ir a HubSpot â†’ âš™ï¸ Settings (esquina superior derecha)
2. En el menÃº lateral: Data Management â†’ Properties
3. Seleccionar pestaÃ±a "Contact properties"
4. Click en botÃ³n "Create property"
5. Completar el formulario:
   - Object type: Contact
   - Group: Buscar "Datos Chatbot" (o crear si no existe)
   - Label: `Email Chatbot`
   - Description: `Correo electrÃ³nico capturado por el chatbot SofÃ­a durante la calificaciÃ³n del lead`
6. Click "Next"
7. Field type: Single-line text
8. Click "Create"

**Nota importante:** Aunque HubSpot tiene un campo `email` nativo, creamos `chatbot_email` para:
- Distinguir emails capturados por el bot vs. otros canales
- Permitir reportes especÃ­ficos de leads del chatbot
- Mantener el email original intacto si ya existe

---

### 4.2 Tarea 22: Crear Propiedad `chatbot_urgency` en Contactos

**UbicaciÃ³n:** HubSpot â†’ Settings â†’ Data Management â†’ Properties â†’ Contact Properties â†’ Create property

| Campo | Valor |
|-------|-------|
| **Object type** | Contact |
| **Group** | Datos Chatbot |
| **Label** | Urgencia/Timeline |
| **Internal name** | `chatbot_urgency` |
| **Field type** | Dropdown select |
| **Description** | Plazo en que el cliente necesita el inmueble, capturado por chatbot SofÃ­a |

**Opciones del Dropdown (en orden):**

| Label | Internal value |
|-------|----------------|
| Inmediato (esta semana) | `inmediato` |
| Este mes | `este_mes` |
| PrÃ³ximos 2-3 meses | `proximo_trimestre` |
| Sin prisa / Explorando | `sin_prisa` |
| No especificado | `no_especificado` |

**Instrucciones paso a paso:**

1. Ir a HubSpot â†’ âš™ï¸ Settings â†’ Data Management â†’ Properties
2. Seleccionar pestaÃ±a "Contact properties"
3. Click en "Create property"
4. Completar:
   - Object type: Contact
   - Group: Datos Chatbot
   - Label: `Urgencia/Timeline`
   - Description: `Plazo en que el cliente necesita el inmueble, capturado por chatbot SofÃ­a`
5. Click "Next"
6. Field type: **Dropdown select**
7. Agregar cada opciÃ³n:
   - Click "Add an option"
   - Label: `Inmediato (esta semana)` â†’ Value: `inmediato`
   - Repetir para cada opciÃ³n
8. Click "Create"

**Alternativa (Single-line text):**
Si prefieres flexibilidad para recibir cualquier texto libre del usuario en lugar de valores predefinidos:

| Campo | Valor |
|-------|-------|
| **Field type** | Single-line text |

Esto permite guardar respuestas como "para el prÃ³ximo lunes", "en 2 semanas cuando termine mi contrato actual", etc.

**RecomendaciÃ³n:** Usar **Single-line text** inicialmente para capturar las respuestas exactas del usuario, y luego crear un dropdown normalizado basado en patrones observados.

---

### 4.3 Tarea 23: Crear Propiedad `chatbot_urgency` en Deals

**UbicaciÃ³n:** HubSpot â†’ Settings â†’ Data Management â†’ Properties â†’ Deal Properties â†’ Create property

| Campo | Valor |
|-------|-------|
| **Object type** | Deal |
| **Group** | Deal Information |
| **Label** | Urgencia Lead |
| **Internal name** | `chatbot_urgency` |
| **Field type** | Single-line text |
| **Description** | Timeline del lead para cerrar el negocio, capturado por chatbot SofÃ­a |

**Instrucciones:**

1. Ir a HubSpot â†’ âš™ï¸ Settings â†’ Data Management â†’ Properties
2. Seleccionar pestaÃ±a "**Deal properties**"
3. Click en "Create property"
4. Completar:
   - Object type: Deal
   - Group: Deal Information (o crear grupo "Datos Chatbot" para deals)
   - Label: `Urgencia Lead`
   - Internal name: `chatbot_urgency`
5. Field type: Single-line text
6. Click "Create"

---

### 4.4 Tarea 24: Actualizar Vista "Leads_Sofia_Nuevos"

**UbicaciÃ³n:** HubSpot â†’ CRM â†’ Contacts â†’ Vista "Leads_Sofia_Nuevos" â†’ Edit columns

**Columnas actualizadas (en orden):**

| # | Columna | Propiedad |
|---|---------|-----------|
| 1 | Nombre | `name` |
| 2 | TelÃ©fono | `phone` |
| 3 | Email | `email` |
| 4 | Email Chatbot | `chatbot_email` |
| 5 | Tipo Propiedad | `chatbot_property_type` |
| 6 | UbicaciÃ³n | `chatbot_location` |
| 7 | Presupuesto | `chatbot_budget` |
| 8 | **Urgencia** | `chatbot_urgency` |
| 9 | Score | `chatbot_score` |
| 10 | Timestamp | `chatbot_timestamp` |
| 11 | Owner | `hubspot_owner_id` |

**Instrucciones:**

1. Ir a HubSpot â†’ CRM â†’ Contacts
2. Seleccionar vista "Leads_Sofia_Nuevos" del dropdown
3. Click en "Edit columns" (o "Actions" â†’ "Edit columns")
4. En el panel derecho:
   - Buscar `chatbot_urgency` y agregarlo
   - Buscar `chatbot_email` y agregarlo
   - Reordenar arrastrando las columnas
5. Click "Apply" o "Save"

---

### 4.5 Tarea 25: Actualizar Tarjetas Kanban con Urgencia

**UbicaciÃ³n:** HubSpot â†’ CRM â†’ Deals â†’ Board view â†’ Customize cards

**Propiedades a mostrar en tarjetas:**

| Propiedad | PropÃ³sito |
|-----------|-----------|
| `dealname` | Nombre del deal (automÃ¡tico) |
| `amount` | Monto/Presupuesto |
| `chatbot_property_type` | Tipo de propiedad |
| `chatbot_location` | UbicaciÃ³n deseada |
| `chatbot_urgency` | **NUEVO:** Timeline del cliente |
| `chatbot_score` | Score de calidad |
| `hubspot_owner_id` | Asignado a |

**Instrucciones:**

1. Ir a HubSpot â†’ CRM â†’ Deals
2. Cambiar a vista "Board" (Kanban)
3. Click en âš™ï¸ "Board actions" â†’ "Edit cards"
4. En el panel de personalizaciÃ³n:
   - SecciÃ³n "Choose the properties to display"
   - Buscar y agregar `chatbot_urgency`
   - Reordenar segÃºn prioridad visual
5. Click "Save"

**Sugerencia de diseÃ±o visual:**
Considera crear una propiedad calculada o usar colores para destacar urgencia:
- ğŸ”´ Inmediato â†’ Prioridad visual alta
- ğŸŸ¡ Este mes â†’ Prioridad media
- ğŸŸ¢ Sin prisa â†’ Prioridad baja

Esto puede configurarse con Workflows (si tienes Sales Hub Professional+).

---

### 4.6 Tarea Extra: Verificar Propiedades Existentes en Deals

**Importante:** Antes de continuar, verificar que las siguientes propiedades ya existan en Deals (creadas en la Fase 2). Si no existen, crearlas:

| Propiedad | Tipo | Internal Name |
|-----------|------|---------------|
| Tipo Propiedad Chatbot | Single-line text | `chatbot_property_type` |
| UbicaciÃ³n Chatbot | Single-line text | `chatbot_location` |
| Presupuesto Chatbot | Number | `chatbot_budget` |
| Score Chatbot | Number | `chatbot_score` |

**CÃ³mo verificar:**

1. Ir a HubSpot â†’ âš™ï¸ Settings â†’ Data Management â†’ Properties
2. Seleccionar "Deal properties"
3. Buscar cada propiedad por nombre
4. Si no existe, crearla siguiendo el mismo proceso de las tareas anteriores

---

## 5. VARIABLES DE ENTORNO

No se requieren nuevas variables de entorno para esta fase. Las propiedades se envÃ­an usando los internal names configurados en HubSpot.

---

## 6. CHECKLIST DE VERIFICACIÃ“N

### 6.1 CÃ³digo

- [ ] `REQUIRED_PROPERTY_FIELDS` incluye `['ubicacion', 'presupuesto', 'correo', 'tiempo']`
- [ ] `PROPERTY_EXTRACTION_PROMPT` extrae `correo` y `tiempo`
- [ ] `PROPERTY_QUALIFICATION_PROMPTS` tiene prompts para `correo` y `tiempo`
- [ ] `PROPERTY_DATA_COMPLETE_PROMPT` formatea `{correo}` y `{tiempo}` correctamente
- [ ] `FIELD_LABELS` incluye `correo` y `tiempo`
- [ ] `contact_properties` incluye `email`, `chatbot_email` y `chatbot_urgency`
- [ ] `deal_properties` incluye `chatbot_urgency`
- [ ] `chatbot_preference` incluye `tiempo` en su construcciÃ³n
- [ ] `_handle_awaiting_property_data` formatea el prompt con `correo` y `tiempo`

### 6.2 HubSpot - Contactos

- [ ] Propiedad `chatbot_email` creada (Single-line text)
- [ ] Propiedad `chatbot_urgency` creada (Single-line text o Dropdown)
- [ ] Vista "Leads_Sofia_Nuevos" actualizada con nuevas columnas

### 6.3 HubSpot - Deals

- [ ] Propiedad `chatbot_urgency` creada en Deals
- [ ] Tarjetas Kanban actualizadas con `chatbot_urgency`
- [ ] Verificadas propiedades existentes: `chatbot_property_type`, `chatbot_location`, `chatbot_budget`, `chatbot_score`

### 6.4 Testing

- [ ] Test: Flujo completo pidiendo ubicaciÃ³n
- [ ] Test: Flujo completo pidiendo presupuesto
- [ ] Test: Flujo completo pidiendo correo
- [ ] Test: Flujo completo pidiendo tiempo
- [ ] Test: Mensaje con todos los datos â†’ salta directo a nombre
- [ ] Test: Datos llegan correctamente al Contacto en HubSpot
- [ ] Test: Datos llegan correctamente al Deal en HubSpot
- [ ] Test: Vista "Leads_Sofia_Nuevos" muestra nuevos campos
- [ ] Test: Tarjetas Kanban muestran urgencia

---

## RESUMEN DE ARCHIVOS A MODIFICAR

| Archivo | Cambios |
|---------|---------|
| `reception_agent.py` | Actualizar `REQUIRED_PROPERTY_FIELDS`, formateo en `_handle_awaiting_property_data` |
| `crm_prompts.py` | Actualizar `PROPERTY_EXTRACTION_PROMPT`, `PROPERTY_QUALIFICATION_PROMPTS`, `PROPERTY_DATA_COMPLETE_PROMPT`, `FIELD_LABELS` |
| `crm_agent.py` | Agregar `chatbot_email`, `chatbot_urgency` a `contact_properties` y `deal_properties`, actualizar `chatbot_preference` |

---

## FLUJO CONVERSACIONAL ACTUALIZADO

```
Usuario: "Quiero arrendar un apartamento"
                â†“
SofÃ­a: "Â¿En quÃ© zona te gustarÃ­a encontrar tu apartamento?"
                â†“
Usuario: "En Chapinero"
                â†“
SofÃ­a: "Â¿CuÃ¡l es tu presupuesto aproximado para arriendo?"
                â†“
Usuario: "Entre 2 y 3 millones"
                â†“
SofÃ­a: "Â¿Me podrÃ­as compartir tu correo electrÃ³nico?"
                â†“
Usuario: "juan@email.com"
                â†“
SofÃ­a: "Â¿Para cuÃ¡ndo necesitas el inmueble?"
                â†“
Usuario: "Lo antes posible, este mes"
                â†“
SofÃ­a: "Â¡Perfecto! Ya tengo toda la informaciÃ³n:
        ğŸ“ Zona: Chapinero
        ğŸ’° Presupuesto: Entre 2 y 3 millones
        ğŸ“§ Correo: juan@email.com
        â° Tiempo: Lo antes posible, este mes
        
        Â¿Me podrÃ­as indicar tu nombre completo?"
                â†“
Usuario: "Juan PÃ©rez"
                â†“
â†’ TRANSFERRED_CRM â†’ HubSpot recibe todos los datos
```

---

**FIN DEL DOCUMENTO COMPLEMENTARIO**

*Generado por Claude - 23 de enero de 2026*