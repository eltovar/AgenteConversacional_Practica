<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Asesores - WhatsApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/whatsapp/panel/static/style.css">
</head>
<body class="bg-gray-100 h-screen overflow-hidden">
    <div class="flex h-full">
        <!-- ======================================================================= -->
        <!-- SIDEBAR: Lista de Contactos -->
        <!-- ======================================================================= -->
        <div class="w-1/3 bg-white border-r flex flex-col">
            <!-- Header -->
            <div class="bg-green-600 text-white p-4">
                <div class="flex items-center justify-between">
                    <h1 id="panelTitle" class="text-lg font-semibold">Asesores Comerciales</h1>
                    <div class="flex items-center gap-2">
                        <span class="pulse text-xs bg-green-500 px-2 py-1 rounded-full">En vivo</span>
                    </div>
                </div>
                <p id="panelSubtitle" class="text-sm opacity-90 mt-1">Inmobiliaria Proteger</p>
            </div>

            <!-- Filtros de tiempo -->
            <div class="p-3 bg-gray-50 border-b">
                <div class="flex flex-wrap gap-2">
                    <select id="timeFilter" class="text-sm border rounded px-2 py-1 flex-1">
                        <option value="24h">Ultimas 24 horas</option>
                        <option value="48h">Ultimas 48 horas</option>
                        <option value="1week">Ultima semana</option>
                        <option value="custom">Personalizado</option>
                    </select>
                    <button id="refreshBtn" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                        &#10227;
                    </button>
                </div>
                <!-- Fechas personalizadas (oculto por defecto) -->
                <div id="customDates" class="hidden mt-2 flex gap-2">
                    <input type="date" id="dateFrom" class="text-sm border rounded px-2 py-1 flex-1">
                    <input type="date" id="dateTo" class="text-sm border rounded px-2 py-1 flex-1">
                    <button id="applyDatesBtn" class="bg-blue-600 text-white px-2 py-1 rounded text-sm">OK</button>
                </div>
            </div>

            <!-- Lista de contactos -->
            <div id="contactsList" class="flex-1 overflow-y-auto">
                <div class="p-4 text-center text-gray-500">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
                    <p class="mt-2 text-sm">Cargando contactos...</p>
                </div>
            </div>

            <!-- Info de actualizacion y contadores -->
            <div class="p-2 bg-gray-50 border-t text-xs text-gray-500">
                <div class="flex justify-between items-center">
                    <span id="activeCounter" class="text-green-600 font-medium"></span>
                    <span id="lastUpdate">Actualizacion: --</span>
                </div>
            </div>
        </div>

        <!-- ======================================================================= -->
        <!-- MAIN: Area de Chat -->
        <!-- ======================================================================= -->
        <div class="w-2/3 flex flex-col">
            <!-- Header del chat (contacto seleccionado) -->
            <div id="chatHeader" class="bg-gray-100 p-4 border-b flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div>
                        <div class="flex items-center gap-1">
                            <h2 id="contactName" class="font-semibold text-gray-700">Selecciona un contacto</h2>
                            <button id="editNameBtn" onclick="openEditNameModal()" class="hidden text-gray-400 hover:text-gray-600 p-1" title="Editar nombre">
                                &#9999;&#65039;
                            </button>
                        </div>
                        <p id="contactPhone" class="text-sm text-gray-500"></p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="windowStatus" class="hidden text-sm"></div>
                    <!-- Boton cerrar conversacion -->
                    <button
                        id="closeConversationBtn"
                        onclick="closeConversation()"
                        class="hidden bg-red-100 hover:bg-red-200 text-red-700 text-xs px-3 py-1 rounded-full transition-colors"
                        title="Cerrar conversacion (reactiva Sofia)"
                    >
                        &#10005; Cerrar
                    </button>
                </div>
            </div>

            <!-- Area de mensajes -->
            <div id="chatMessages" class="flex-1 overflow-y-auto chat-bg p-4">
                <div class="flex items-center justify-center h-full text-gray-500">
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <p>Selecciona un contacto para ver la conversacion</p>
                    </div>
                </div>
            </div>

            <!-- Input de mensaje -->
            <div class="bg-gray-100 p-4 border-t">
                <!-- Warning de ventana cerrada (solo el aviso) -->
                <div id="windowWarning" class="hidden mb-3 p-2 bg-orange-50 border border-orange-200 rounded-lg">
                    <div class="flex items-center gap-2">
                        <span class="text-orange-600">&#9888;&#65039;</span>
                        <span class="text-sm text-orange-700">Ventana de 24h cerrada. Usa un template para reactivar la conversacion.</span>
                    </div>
                </div>

                <!-- SELECTOR DE TEMPLATES - SIEMPRE VISIBLE -->
                <div id="templateSection" class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-blue-600">&#128221;</span>
                        <span class="text-sm text-blue-700 font-medium">Enviar template</span>
                        <span class="text-xs text-gray-500">(Mensajes predefinidos)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="templateSelector" class="flex-1 text-sm border rounded px-2 py-1 bg-white">
                            <option value="">Seleccionar template...</option>
                        </select>
                        <button
                            type="button"
                            id="sendTemplateBtn"
                            onclick="sendTemplateMessage()"
                            class="bg-blue-500 text-white text-sm px-3 py-1 rounded hover:bg-blue-600 disabled:bg-gray-300"
                            disabled
                        >
                            Enviar Template
                        </button>
                        <button
                            type="button"
                            onclick="openTemplateModal()"
                            class="text-gray-500 hover:text-gray-700 text-sm px-2 py-1"
                            title="Administrar templates"
                        >
                            &#9881;&#65039;
                        </button>
                    </div>
                    <div id="templatePreview" class="hidden mt-2 p-2 bg-white rounded border text-sm text-gray-600"></div>
                </div>

                <!-- INPUT DE TEXTO LIBRE -->
                <form id="sendForm" class="flex gap-2">
                    <input type="hidden" id="selectedPhone" value="">
                    <input type="hidden" id="selectedContactId" value="">
                    <textarea
                        id="messageInput"
                        placeholder="Escribe un mensaje personalizado..."
                        class="flex-1 border rounded-lg p-3 resize-none focus:outline-none focus:ring-2 focus:ring-green-500"
                        rows="2"
                        disabled
                    ></textarea>
                    <button
                        type="submit"
                        id="sendBtn"
                        class="bg-green-600 text-white px-6 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                        disabled
                    >
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </form>
                <div id="sendResult" class="mt-2 text-sm hidden"></div>
            </div>
        </div>
    </div>

    <!-- Script con variables inyectadas desde el servidor -->
    <script>
        // Variables inyectadas por Jinja2
        const API_KEY = '{{ api_key }}';
        const BASE_URL = '{{ base_url }}';
        const ADVISOR_NAMES = {{ advisor_names | tojson }};
    </script>
    <script src="/whatsapp/panel/static/index.js"></script>
</body>
</html>
